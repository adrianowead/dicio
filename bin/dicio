#!/usr/bin/env node

'use strict';

var iconv = require('iconv-lite');
var removeAccents = require('remover-acentos');
var request = require('request');

function wordNotFound() {
    console.error('Palavra não encontrada.');
    process.exit(1);
}

if (process.argv.length === 2) {
    console.log('Uso: dicio <palavra>');
    process.exit(0);
}

var word = removeAccents(process.argv[2]).toLowerCase();

var url = 'https://dicionariodoaurelio.com/' + word;

var callback = function (error, response, body) {
    if (response.statusCode === 302) {
        wordNotFound();
    }

    if (response.statusCode !== 200) {
        console.error('Serviço indisponível.');
        process.exit(1);
    }

    if (error) {
        console.error('Erro!');
        process.exit(1);
    }

    body = iconv.decode(new Buffer(body), 'UTF-8')
            .split('<article>')[1]
            .split('</article>')[0]
            .replace(/<h2>Significado\sde\s.*<\/h2>/g, '')
            .replace(/<br>/g, '')
            .trim();

    if (body === '') {
        wordNotFound();
    }

    console.log(body);
};

request.get({
    'uri': url,
    'encoding': null
}, callback);
