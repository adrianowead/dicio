#!/usr/bin/env node

'use strict';

var diacritics = require('diacritic');
var http = require('http');
var iconv = require('iconv-lite');

function wordNotFound() {
    console.error('Palavra não encontrada.');
    process.exit(1);
}

var word = diacritics.clean(process.argv[2]).toLowerCase();

if (!word.length) {
    console.log('Uso: dicio <palavra>');
    process.exit(0);
}

var options = {
    host: 'dicionariodoaurelio.com',
    path: '/' + word
};

var callback = function (response) {
    if (response.statusCode === 302) {
        wordNotFound();
    }

    if (response.statusCode !== 200) {
        console.error('Serviço indisponível.');
        process.exit(1);
    }

    response.pipe(iconv.decodeStream('ISO-8859-1')).collect(function (error, body) {
        if (error) {
            console.error('Erro!');
            process.exit(1);
        }

        var re = /class='descricao'>/;

        if (!re.test(body)) {
            wordNotFound();
        }

        var text = body.split(re)[1].split('</span>')[0];

        if (!text.length) {
            wordNotFound();
        }

        console.log(text.replace(/<br>/g, '\n'));
    });
};

http.get(options, callback).end();
